---
title: Species Overview for Region 2 
params:
  taxon_id: "NA"
format:
  docx:
    reference-doc: 'data\template\SpeciesOverviewTemplate_508_20240308.docx'
    df-print: kable
    knitr:
      opts_chunk:
        dev: 'ragg_png'
        dpi: 300
        out.width: '100%'
execute:
  echo: false
  message: false
  warning: false
  class-output: 'r'
  fig-width: 8
---

```{r}
options(
  max.print = 100,
  vsc.use_httpgd = TRUE,
  device = "windows"
)
library(tidyverse)
library(sf)
library(sjnftools)
library(readxl)
library(glue)
library(taxize)
library(ebirdst)
library(targets)

current_taxon_id <- "2480566"
# taxon_id <- params$taxon_id
species_data <- tar_read(summary_sheet) |>
  dplyr::filter(taxon_id == current_taxon_id)
# species_id <- params$scientific_name





```

```{r}
common_name <- species_data$common_name
sci_name <- species_data$scientific_name
known_to_occur <- ifelse(species_data$planArea_native & species_data$planArea_present, "Yes", "No")
last_date_occ<-max(species_data$IMBCR_maxYear, species_data$iDB_maxYear, species_data$GBIF_maxYear, species_data$SDNHP_lastYear, species_data$NENHP_lastYear, na.rm=T)
```

## Species

:::{custom-style="Body Text"}
Species Common Name: `r common_name`

Species Scientific Name: `r sci_name`

Species is Native to, and Known to Occur in, National Forest System lands in Plan Area: `r known_to_occur`

&emsp;&emsp;Rationale/Evidence of Occurrence: 
```{r}
#| label: fig-obs
#| fig-cap: "Number of observations in each database"

species_data|>
  select(contains("nObs"))|>
  mutate(
    across(everything(), ~replace_na(.x, 0))
  )|>
  rename(
    "Nebraska Natural Heritage Program" =  NENHP_nObs,
    "South Dakota National Heritage Program" = SDNHP_nObs,
    "GBIF Occurrence Database" = GBIF_nObs,
    "iDigBio Occurrence Database" = iDB_nObs,
    "Bird Conservancy of the Rockies" = IMBCR_nObs
  )|>
  pivot_longer(everything(),names_to="Source", values_to="Count")
```

&emsp;&emsp;Year of Last Known Occurrence: `r last_date_occ`
:::

## Species Status

```{r}
#| label: species-status
#| fig-cap: "summarizes the current status of this species or subspecies by various ranking entities and defines the meaning of the status."
species_data |>
  select(rounded_gRank, NE_sRank, SD_sRank, R2_RFSS_List, usfws_esa) |>
  rename(
    NatureServe = rounded_gRank,
    `State Rank - Nebraska` = NE_sRank,
    `State Rank - South Dekota` = SD_sRank,
    `US Fish and Wildlife Service` = usfws_esa
  ) |>
  mutate(`US Forest Service` = ifelse(R2_RFSS_List, "Region 2 Sensitive Species", NA)) |>
  select(-R2_RFSS_List) |>
  pivot_longer(cols = NatureServe:`US Forest Service`, names_to = "Entity", values_to = "Status")
```

## Taxonomy
```{r}
tsn<-get_tsn(sci_name)
class<-classification(tsn)
accepted_name<-class[[tsn]]|>
  tail(1)|>
  pull(name)
  attr(tsn, "uri")
```

The accepted species name according to ITIS is `r accepted_name` (TSN: [`r tsn`](`r attr(tsn, "uri")`)). 

## Species range
```{r}
# ebirdst_download_status(sci_name, download_ranges=TRUE)
ranges <- load_ranges(sci_name, resolution = "9km")

range_rast<-load_raster(sci_name, product="abundance", period="seasonal", resolution="27km")
plot(range_rast$breeding)

ggplot()+
  geom_sf(data=ranges, aes(fill=season))+
  theme_void()
```
### Overall Species range

### Description of how the population in the plan area fits within the overall range

## Distribution, abundance, and trend in the plan area
### Population
if(class=="Aves")
```{r eval=(species_data$class=="Aves")}
core_index |>
  filter(region == "KAN" & species_name == common_name & !is.na(index)) |>
  ggplot(aes(year, index, ymin = ci_2.5_percenti, ymax = ci_97.5_percent)) +
  geom_line(linewidth = 1) +
  geom_ribbon(alpha = 0.35, fill = "#0C6291") +
  theme_minimal(base_family = "Fira Code") +
  scale_x_continuous(breaks = seq(1965, 2022, 5)) +
  scale_y_continuous(breaks = seq(0, 40, 5)) +
  labs(
    title = glue("{common_name} Population Index in Kansas"),
    subtitle = "Breeding Bird Survey Data (USGS), 1966 to 2022",
    y = "Index",
    x = ""
  ) +
  theme(
    plot.title = element_text(face = "bold")
  )
```

```{r}
core_index |>
  filter(region == "NEB" & species_name == common_name & !is.na(index)) |>
  ggplot(aes(year, index, ymin = ci_2.5_percenti, ymax = ci_97.5_percent)) +
  geom_line(linewidth = 1) +
  geom_ribbon(alpha = 0.35, fill = "#0C6291") +
  theme_minimal(base_family = "Fira Code") +
  scale_x_continuous(breaks = seq(1965, 2022, 5)) +
  scale_y_continuous(breaks = seq(0, 40, 5)) +
  labs(
    title = glue("{common_name} Population Index in Nebraska"),
    subtitle = "Breeding Bird Survey Data (USGS), 1966 to 2022",
    y = "Index",
    x = ""
  ) +
  theme(
    plot.title = element_text(face = "bold")
  )
```

### Habitat

## Threats (arising from on or off the plan area) 

### Population

### Habitat

## Ecological conditions

### Ecological condition requirements

### Amount, quality, distribution, connectivity, status, and trend of ecological conditions in plan area

### Critical biological characteristics

## Important ecological and biological interactions
### How (or if) this species influences other species or ecosystem diversity or integrity

### Influence of ecosystem structure and function on this species (includes departure from NRV or new influences)

## Maps of Species Range and Known Occurrences in Plan Area
```{r}
ggplot() +
  geom_sf(data = sjnf_bd) +
  theme_void(base_family = "Fira Code") +
  labs(
    title = "This is a map",
    subtitle = "We could pull data from whatever DB and make maps"
  )
```

## References

