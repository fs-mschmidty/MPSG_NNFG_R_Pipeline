---
params: 
  # taxon_id: "2491123"
  taxon_id: "2474941"
format:
  docx:
    reference-doc: 'template_styles/template_mpsg_styles.docx'
    df-print: kable
    knitr:
      opts_chunk:
        dev: 'ragg_png'
        fig-width: 6.5
        # fig-height: 6
execute:
  echo: false
  message: false
  warning: false
  class-output: 'r'
  fig-width: 6.5
---

```{r}
library(tidyverse)
library(sf)
library(targets)
library(glue)
library(rnaturalearth)
library(ggtext)
library(ggspatial)
library(extrafont)
loadfonts(quiet = T)

t_id <- params$taxon_id
species_data <- tar_read(output_dne_eligible_lists) |>
  filter(taxon_id == t_id) |>
  mutate(
    min_overall_year = min(c_across(contains("minYear")), na.rm = T)
  )

sp_names <- glue("{species_data$common_name} (*{species_data$scientific_name}*)")
```
:::{custom-style="Body Text"}
# `r species_data$common_name`
(*`r species_data$scientific_name`*)

## Species observation records and conservation categories

### What, if any, are the scientific name synonyms for the species

```{r}
synonyms <- tar_read(eligible_synonyms) |>
  filter(taxon_id == t_id) |>
  pull(canonicalName)

citation <- "{GBIF Secretariat 2023}"

if (length(synonyms) > 0) {
  synonyms <- synonyms |>
    paste(collapse = ", ")

  synonyms <- glue("Current and historic synonyms for {species_data$scientific_name} are: *{synonyms}* {citation}.")
} else {
  synonyms <- glue("There are no known synonyms for this species {citation}.")
}
```

`r synonyms`

### NatureServe Conservation Status (Global/State):

`r glue("{species_data$rounded_gRank}/{species_data$NE_sRank}(NE), {species_data$SD_sRank}(SD)")`

### Additional Qualifying Conservation Categories (including Local Concern)

```{r}
# I need to make sure this works if there are no other rankings.

other_ranking_narrative <- if (
  !is.na(species_data$r2_ss_list) |
    !is.na(species_data$nebraska_swap) |
    !is.na(species_data$sd_te) |
    !is.na(species_data$usfws_status)
) {
  species_data |>
    mutate(
      other_rankings = glue(
        ifelse(!is.na(r2_ss_list), "Region 2 Sensitive Species, ", ""),
        ifelse(!is.na(nebraska_swap), "Nebraska SWAP {nebraska_swap}, ", ""),
        ifelse(!is.na(sd_te), "South Dakota {sd_te}", ""),
        ifelse(!is.na(usfws_status), "FWS {usfws_status}, ", "")
      ),
      other_rankings = str_replace(other_rankings, ".{2}$", ".")
    ) |>
    pull(other_rankings)
} else {
  "No other qualifying conservation categories apply to this species."
}
```

`r other_ranking_narrative`

### Number of Occurrence records by Data Source

```{r}
number_of_occ <- species_data |>
  mutate(
    occ_by_source = glue(
      "Observations: ",
      ifelse(!is.na(GBIF_nObs) & GBIF_nObs != 0, "GFIB - {GBIF_nObs}, ", ""),
      ifelse(!is.na(iDB_nObs) & iDB_nObs != 0, "iDigBio - {iDB_nObs}, ", ""),
      ifelse(!is.na(SEI_nObs) & SEI_nObs != 0, "Seinet - {SEI_nObs}, ", ""),
      ifelse(!is.na(IMBCR_nObs) & IMBCR_nObs != 0, "Bird Conservancy of the Rockies - {IMBCR_nObs}, ", ""),
      ifelse(!is.na(NENHP_nObs) & NENHP_nObs != 0, "Nebraska Natural Heritage - {NENHP_nObs}, ", ""),
      ifelse(!is.na(SDNHP_nObs) & SDNHP_nObs != 0, "South Dakota Natural Heritage - {SDNHP_nObs}, ", "")
    )
  ) |>
  pull(occ_by_source) |>
  str_replace(".{2}$", ".")
```
`r number_of_occ`

#### Year of first and last observation for all occurrence data: 

First: `r species_data$min_overall_year`, Last: `r species_data$max_overall_year`

### Is the species currently federally designated as threatened, endangered, proposed, or candidate species under the Endangered Species Act?

```{r}
if (is.na(species_data$usfws_status)) {
  fed_status_string <- "No"
} else if (species_data$usfws_status == "Under Review") {
  fed_status_string <- glue("No. Current USFWS status: {species_data$usfws_status}.")
} else {
  fed_status_string <- glue("Yes. Current USFWS status: {species_data$usfws_status}.")
}
```

`r fed_status_string`

### Species' Native Range 

```{r}
## Base plot style.
p_base <- ggplot() +
  theme_minimal(base_family = "Roboto Condensed") +
  ggspatial::annotation_north_arrow(
    location = "br",
    which_north = "true",
    height = unit(0.33, "in"),
    width = unit(0.33, "in"),
    style = north_arrow_fancy_orienteering()
  ) +
  theme(
    plot.background = element_rect(color = "black", linewidth = 1),
    plot.title = element_markdown(face = "bold", hjust = 0, margin = margin(0, 0, 5, 0, "pt")),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10, "pt"),
    plot.caption = element_markdown(),
    legend.title = element_markdown(),
    legend.position = "inside",
    legend.position.inside = c(0.15, 0.1),
    legend.box.background = element_rect(color = "black", linewidth = 0.5, fill = "white"),
    legend.box.margin = margin(0, 3, 0, 3, unit = "pt")
  )

base_map_data <- tar_read(evaluation_base_map_data)
```
:::

:::{custom-style="Caption"}

```{r}    
#| label: cont-range
#| fig-cap: "Range within the Continental United States"
#| fig-alt: "Range within the Continental United States"
#| fig-height: 6


m_source <- tar_read(map_source) |>
  filter(taxon_id == t_id) |>
  pull(source)
if (is.na(m_source)) {
  m_source <- "No Map Available"
}

if (m_source == "BIEN" | m_source == "IUCN") {
  base_area <- base_map_data$l_48

  aoa <- tar_read(nnfg_aoa) |>
    st_transform(st_crs(base_area))

  if (m_source == "BIEN") {
    g_map_data <- tar_read(bien_plant_maps)
    source_statement <- "**Source**:Botanical Information and Ecology Network."
  }
  if (m_source == "IUCN") {
    g_map_data <- tar_read(all_iucn_map)
    source_statement <- "**Source: IUCN Spatila Data**"
  }

  g_map_data <- g_map_data |>
    filter(taxon_id == t_id) |>
    st_transform(st_crs(base_area)) |>
    st_intersection(st_union(base_area))

  p_base +
    geom_sf(data = base_area, fill = "grey30", color = "white") +
    geom_sf(data = g_map_data, aes(fill = "Overall Range"), color = "transparent", alpha = 0.8) +
    geom_sf(data = aoa, fill = "yellow", color = "transparent") +
    scale_fill_manual(values = c("#1e8449")) +
    labs(
      title = sp_names,
      subtitle = "Continental United States Range",
      fill = "**Legend**",
      caption = source_statement,
    )
}
```

```{r}
#| label: breeding-range
#| fig-cap: "North American Seasonal Ranges"
#| fig-alt: "North American Seasonal Ranges"
#| fig-height: 6.5
if (m_source == "EBIRD" | is.na(m_source)) {
  base_area <- base_map_data$north_america

  aoa <- tar_read(nnfg_aoa) |>
    st_transform(st_crs(base_area))
  if (is.na(m_source)) {
    g_map_data <- tar_read(gbif_occ_data) |>
      filter(taxon_id == t_id) |>
      st_transform(st_crs(base_area)) |>
      st_intersection(base_area |> st_union())

    p_base_a <- p_base +
      geom_sf(data = base_area, fill = "grey30", color = "white") +
      geom_sf(data = g_map_data, aes(color = "Occurrence Record"), size = 2) +
      scale_color_manual(values = c("#1e8449")) +
      labs(
        title = sp_names,
        subtitle = "North American Range",
        color = "**Legend**",
        caption = "**Source:** GBIF occurrence records. "
      )
  } else if (m_source == "EBIRD") {
    g_map_data <- tar_read(bird_maps) |>
      filter(taxon_id == t_id) |>
      st_transform(st_crs(base_area)) |>
      st_intersection(base_area |> st_union())

    p_base_a <- p_base +
      geom_sf(data = base_area, fill = "grey30", color = "white") +
      geom_sf(data = g_map_data, aes(fill = season), color = "transparent") +
      scale_fill_brewer(palette = "Dark2") +
      labs(
        title = sp_names,
        subtitle = "North American Range",
        fill = "**Season**",
        caption = "**Source:** eBird Status and Trends"
      )
  }

  if (nrow(g_map_data) > 0) {
    p_base_a +
      geom_sf(data = base_area, fill = "transparent", color = "white") +
      geom_sf(data = aoa, fill = "yellow", color = "transparent")
  }
}
```


:::
:::{custom-style="Caption"}
```{r}
#| label: occurrence-records
#| fig-cap: "Occurrence records within Nebraska National Forests and Grasslands."
#| fig-alt: "North American Seasonal Ranges"
#| fig-height: 6.35

sp_points <- tar_read(all_eligible_spatial_data_point) |>
  filter(taxon_id == t_id)

sp_polys <- tar_read(all_eligible_spatial_data_poly) |>
  filter(taxon_id == t_id)

unit_sp <- tar_read(nnfg_bd)
own <- tar_read(nnfg_fs_ownership)

labels <- base_map_data$nnfg_dist %>%
  bind_cols(st_coordinates(st_centroid(.))) |>
  mutate(
    name_sub = str_replace(DISTRICTNAME, " Ranger District", ""),
    label_n = glue("{name_sub} RD"),
    X = case_when(
      OBJECTID == 429949 ~ 850000,
      OBJECTID == 429950 ~ 630000,
      OBJECTID == 429951 ~ 620000,
      TRUE ~ X
    ),
    Y = case_when(
      OBJECTID == 429949 ~ 4700000,
      name_sub == "Wall" ~ 4885000,
      name_sub == "Pine Ridge" ~ 4700000,
      name_sub == "Ft. Pierre" ~ 4870000,
      name_sub == "Fall River" ~ 4805000,
      TRUE ~ Y
    )
  )

roads <- base_map_data$nnfg_roads |>
  select(highway, `tiger:name_base`:`tiger:name_base_4`)
motorways <- roads |>
  filter(highway == "motorway") |>
  mutate(name = case_when(
    `tiger:name_base` == "I-190" ~ "I-90",
    TRUE ~ `tiger:name_base`
  )) |>
  count(name)

trunk <- roads |>
  filter(highway == "trunk")

other_rd <- roads |>
  filter(highway %in% c("primary"))

states <- base_map_data$l_48 |>
  st_transform(st_crs(unit_sp)) |>
  filter(name %in% c("Nebraska", "South Dakota", "Wyoming"))

state_labels <- tibble(
  label = c("South Dakota", "Nebraska"),
  x = c(885000, 885000),
  y = c(4777000, 4767000)
)
wyoming_label <- tibble(
  label = c("Wyoming"),
  x = c(576517.7),
  y = c(4900000)
)

p_base +
  geom_sf(data = unit_sp, fill = "grey70", color = "transparent") +
  geom_sf(data = own, fill = "darkgreen", color = "transparent", alpha = 0.5) +
  geom_sf(data = trunk, color = "grey80", linewidth = 1) +
  geom_sf(data = other_rd, color = "grey80", linewidth = 0.5) +
  geom_sf(data = motorways, color = "grey30", linewidth = 1) +
  geom_sf_label(
    data = motorways,
    aes(label = name),
    fill = "black",
    color = "white",
    nudge_x = -33300,
    nudge_y = 18000,
    label.r = unit(0.8, "lines"),
    label.padding = unit(0.35, "lines")
  ) +
  geom_sf(data = states, color = "black", linewidth = 1, fill = "transparent", linetype = "dotdash") +
  geom_sf(data = labels, fill = "transparent", color = "grey30") +
  geom_label(data = labels, aes(X, Y, label = label_n), show.legend = FALSE, size = 3) +
  geom_text(data = state_labels, aes(x, y, label = label), size = 3, color = "#999999") +
  geom_text(data = wyoming_label, aes(x, y, label = label), size = 3, color = "#999999", angle = 90, nudge_x = -7500) +
  geom_sf(data = sp_polys, fill = "#1e8449") +
  geom_sf(data = sp_points, size = 2.5, aes(color = "Observation"), alpha = 0.7) +
  scale_color_manual(values = c("#7d3c98")) +
  labs(
    title = sp_names,
    subtitle = "Occurrence records within the Nebraska National Forests and Grasslands",
    color = "**Legend**",
    x = "",
    y = ""
  ) +
  scale_x_continuous(limits = c(567517.7, 899630)) +
  scale_y_continuous(limits = c(4624402.1, 4914917)) +
  theme(
    axis.text = element_blank(),
    panel.grid = element_blank()
  )
```
:::
:::{custom-style="Body Text"}


### Is the species native and known to occur?

```{r}
nn_base <- species_data |>
  pull(`Is the Species Native and Known to Occur`)

nn_basi <- species_data |>
  pull(`What is the rationale and supporting BASI for recommending that an observation does not meet the requirements of native to, and known to occur in the plan area?`)
```

`r nn_base`

#### Justification for ‘no’:

`r ifelse(is.na(nn_basi), "", nn_basi)`

## Species information

### Species Current Range Size and Configuration

#### What is the size of the species' range?

[Large, Moderate, Regional Endemic, State Endemic, Local Endemic – refer to process paper for category definitions]

#### Is the portion of the species range that overlaps the plan area disjunct from the main range of the species (i.e., the range overlapping the plan area is smaller and not connected to the larger range of the species)?

[Yes, No, Unknown]

#### What is the distance between the plan area and the closest edge of the species range? 
[unknown (i.e., no known range for the species), 0 miles (i.e. species range transects the plan area), 1-50 miles, 51-150 miles, 151-500 miles, 500 or more miles.]   

### Species’ Landscape-scale Habitat

#### What are the landscape-scale habitat types or ecosystems the species occupies based on Best Available Scientific Information (BASI), including literature from outside of the plan area?

```{r}
ns_habs<-tar_read(ns_habitats) |>
  filter(taxon_id==t_id)

comments<-ns_habs |>
  filter(hab_cat=="comments")

if(nrow(comments)=1){
  comment_narrative<-comments |>
    pull(ns_hap)
} else {
  comment_narrative<-"NO COMMENT NARRATIVE WAS GENERATED FROM NATURESERVE"
}
```
`r comment_narrative`

[Narrative description pulled in from NatureServe– will need manual review to ensure fine-scale habitat features are not mixed in with landscape, and additional BASI as appropriate; NatureServe also doesn’t capture many plants, so this may also need to be written manually]

#### Based on BASI about the landscape-scale habitat types or ecosystems the species occupies, what landscape-scale habitat types or ecosystems in the plan area are likely to support the species?

[Checklist of categories from Ecology Group pulled in from spreadsheet – this will get pulled in automatically from Mike’s NatureServe pull + crosswalk, but will still require manual review for accuracy (especially for the plantation category)]

#### Macrohabitat Availability and Distribution

[See Appendix.]

#### Species Response to Macrohabitat Threats and Trends

[Default: All threats and trends shown in the Appendix for this species’ macrohabitat are assumed to translate directly to this species.

`r str_to_upper("Manually review and bring in any species-specific info about how the species responds to general habitat trends/threats. The appendix explains the macrohabitat availability, distribution, and threats, but this is where you would connect it to the species- e.g., if fire is a threat, but species actually needs fire for its seeds to germinate, or it actually uses roadside habitat so road development is not as much of a threat")`].

### Species Fine-scale Habitat

#### What are the fine-scale habitat types or ecosystems the species occupies based on BASI, including literature from outside of the plan area?

[`r str_to_upper("Narrative description from literature. To help focus the evaluation on issues that are likely to affect a species long-term persistence the inclusion of fine-scale habitat conditions or features here, should be limited to consideration of conditions or features that: 1) BASI indicates are limited in abundance or distribution, 2) BASI suggest are declining in abundance or distribution, or 3) BASI indicates have a disproportionate value to the population dynamics and distribution of the species because of the species specialized association with the feature or life history dependence (e.g., rare nesting substrate, rare soil type, cold water refugia).")`]

#### Fine-scale Habitat Availability and Distribution

[`r str_to_upper("For many species this will be unknown, but this is where you could put info on if certain microhabitat components are limited in the plan area, such as snags or coldwater refugia, etc.")`]

#### Fine-scale Habitat Threats and Trends 

[`r str_to_upper("but provide narrative discussing species-specific information")`]

### Population 

#### Abundance and distribution

```{r}
imbcr_narrative <- tar_read(imbcr_trend_narratives) |>
  filter(species == species_data$common_name)

if (nrow(imbcr_narrative) == 1) {
  imbcr_narrative <- imbcr_narrative |>
    pull(narrative)
} else {
  imbcr_narrative <- "No narrative"
}

bbs_narrative <- tar_read(bbs_trend_narratives) |>
  filter(species_name == species_data$common_name)

if (nrow(bbs_narrative) == 1) {
  bbs_narrative <- bbs_narrative |>
    pull(final_narrative)
} else {
  bbs_narrative <- "No narrative"
}
```

`r ifelse(imbcr_narrative!="No narrative", imbcr_narrative, "")`

`r ifelse(bbs_narrative!="No narrative", bbs_narrative, "")`



[Default: There are no known population estimates for the species in the plan area. `r str_to_upper("Bird trends? Pull in information from species records, literature, reports, species distribution models, etc.")`]

#### Threats and trends 

[Default: There are no known specific population trends for the species in the plan area. Beyond threats documented across the species range {CITATIONS}, there are no known unique threats to the species within the plan area.]

### Natural and Life History Characteristics that Inform Species Persistence 

#### Dispersal ability

[`r str_to_upper("Brief, ~ one sentence description of species’ movement scale and its overall dispersal capacity")`]

#### Life History Strategy

[`r str_to_upper("Brief, ~ one sentence description of species’ life history, recognizing species generally fit one of these categories (equivalent is annual/perennial for plants): Slow: large body size, long generation, high survival, low reproductive investment; Fast: small body size, short generation, low survival, high reproductive investment")`] 

#### Ecological specialization 

[`r str_to_upper('Habitat or Substrate Specialist, Dietary Specialist, Symbiotic (mutualistic, parasitic, or commensal)')`]

#### Other Factors

[Default: Unknown but review literature for things like: Inbreeding/Drift/Outbreeding/Hybridization/Density Dependence/Allee Effects]

## Specialist Recommendation:

### Sufficiency of BASI  

[`r str_to_upper('Low information/medium information/high information')`] 

### MPSG Specialist Recommendation   

[`r str_to_upper('Likely to be of concern/not likely to be of concern')`] 

### Rationale 

[`r str_to_upper('Short narrative – see: Determination Rational Support.xlsx')`]

## References
:::



