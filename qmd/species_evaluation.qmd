---
params: 
  # id: "2684709"
  taxon_id: "2491123"
format:
  docx:
    reference-doc: 'template_styles/template_mpsg_styles.docx'
    df-print: kable
    knitr:
      opts_chunk:
        dev: 'ragg_png'
        fig-width: 6.5
        # fig-height: 6
execute:
  echo: false
  message: false
  warning: false
  class-output: 'r'
  fig-width: 6.5
---

```{r}
library(tidyverse)
library(sf)
library(targets)
library(glue)
library(rnaturalearth)
library(ggtext)
library(ggspatial)
# library(extrafont)
# loadfonts(quiet = T)

t_id <- params$taxon_id
species_data <- tar_read(output_dne_eligible_lists) |>
  filter(taxon_id == t_id) |>
  mutate(
    min_overall_year = min(c_across(contains("minYear")), na.rm = T)
  )

sp_names <- glue("{species_data$common_name} (*{species_data$scientific_name}*)")
```
:::{custom-style="Body Text"}
# `r sp_names`

## Species observation records and conservation categories

### What, if any, are the scientific name synonyms for the species

```{r}
synonyms <- tar_read(eligible_synonyms) |>
  filter(taxon_id == t_id) |>
  pull(canonicalName)

citation <- "{GBIF Secretariat 2023}"

if (length(synonyms) > 0) {
  synonyms <- synonyms |>
    paste(collapse = ", ")

  synonyms <- glue("Current and historic synonyms for {species_data$scientific_name} are: {synonyms} {citation}.")
} else {
  synonyms <- glue("There are no known synonyms for this species {citation}.")
}
```

`r synonyms`
**[SPECIALISTS REVIEW USDA PLANTS AND OTHER LITERATURE FOR MORE SPECIES.]**

### NatureServe Conservation Status (Global/State):

`r glue("{species_data$rounded_gRank}/{species_data$NE_sRank}(NE), {species_data$SD_sRank}(SD)")`

### Additional Qualifying Conservation Categories (including Local Concern)

```{r}
# I need to make sure this works if there are no other rankings.

other_ranking_narrative <- if (
  !is.na(species_data$r2_ss_list) |
    !is.na(species_data$nebraska_swap) |
    !is.na(species_data$sd_te) |
    !is.na(species_data$usfws_status)
) {
  species_data |>
    mutate(
      other_rankings = glue(
        ifelse(!is.na(r2_ss_list), "Region 2 Sensitive Species, ", ""),
        ifelse(!is.na(nebraska_swap), "Nebraska SWAP {nebraska_swap}, ", ""),
        ifelse(!is.na(sd_te), "South Dakota {sd_te}", ""),
        ifelse(!is.na(usfws_status), "FWS {usfws_status}, ", "")
      ),
      other_rankings = str_replace(other_rankings, ".{2}$", ".")
    ) |>
    pull(other_rankings)
} else {
  "No other qualifying conservation cateries apply to this species."
}
```

`r other_ranking_narrative`

### Number of Occurrence records by Data Source

```{r}
number_of_occ <- species_data |>
  mutate(
    occ_by_source = glue(
      "Observations: ",
      ifelse(!is.na(GBIF_nObs) & GBIF_nObs != 0, "GFIB - {GBIF_nObs}, ", ""),
      ifelse(!is.na(iDB_nObs) & iDB_nObs != 0, "iDigBio - {iDB_nObs}, ", ""),
      ifelse(!is.na(SEI_nObs) & SEI_nObs != 0, "Seinet - {SEI_nObs}, ", ""),
      ifelse(!is.na(IMBCR_nObs) & IMBCR_nObs != 0, "Bird Conservancy of the Rockies - {IMBCR_nObs}, ", ""),
      ifelse(!is.na(NENHP_nObs) & NENHP_nObs != 0, "Nebraska Natural Heritage - {NENHP_nObs}, ", ""),
      ifelse(!is.na(SDNHP_nObs) & SDNHP_nObs != 0, "South Dakota Natural Heritage - {SDNHP_nObs}, ", "")
    )
  ) |>
  pull(occ_by_source) |>
  str_replace(".{2}$", ".")
```
`r number_of_occ`

#### Year of first observation for the combined data: 

`r species_data$min_overall_year`

#### Year of last observation for the combined data: 

`r species_data$max_overall_year`

### Is the species currently federally designated as threatened, endangered, proposed, or candidate speecies under the Endangered Species Act?

```{r}
if (is.na(species_data$usfws_status)) {
  fed_status_string <- "No"
} else if (species_data$usfws_status == "Under Review") {
  fed_status_string <- glue("No. Current USFWS status: {species_Data$usfws_status}.")
} else {
  fed_status_string <- glue("Yes. Current USFWS status: {species_data$usfws_status}.")
}
```

`r fed_status_string`

### Species' Native Range 

```{r}
## Base plot style.
p_base <- ggplot() +
  theme_minimal() +
  ggspatial::annotation_north_arrow(
    location = "br",
    which_north = "true",
    height = unit(0.33, "in"),
    width = unit(0.33, "in"),
    style = north_arrow_fancy_orienteering()
  ) +
  theme(
    plot.background = element_rect(color = "black", linewidth = 1),
    plot.title = element_markdown(face = "bold", hjust = 0, margin = margin(0, 0, 5, 0, "pt")),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10, "pt"),
    plot.caption = element_markdown(),
    legend.title = element_markdown(),
    legend.position = "inside",
    legend.position.inside = c(0.15, 0.1),
    legend.box.background = element_rect(color = "black", linewidth = 0.5, fill = "white"),
    legend.box.margin = margin(5, 5, 5, 5, unit = "pt")
  )
```
:::

:::{custom-style="Caption"}

```{r}    
#| label: fig-cont-range
#| fig-cap: "Range within the Continental United States"
#| fig-alt: "Range within the Continental United States"
#| fig-height: 6


m_source <- tar_read(map_source) |>
  filter(taxon_id == t_id) |>
  pull(source)


if (m_source == "BIEN" | m_source == "IUCN") {
  base_area <- tar_read(evaluation_base_map_data)$l_48

  aoa <- tar_read(nnfg_aoa) |>
    st_transform(st_crs(base_area))

  if (m_source == "BIEN") {
    g_map_data <- tar_read(bien_plant_maps)
    source_statement <- "**Source**:Botanical Information and Ecology Network."
  }
  if (m_source == "IUCN") {
    g_map_data <- tar_read(all_iucn_map)
    source_statement <- "**Source: IUCN Spatila Data**"
  }

  g_map_data <- g_map_data |>
    filter(taxon_id == t_id) |>
    st_transform(st_crs(base_area)) |>
    st_intersection(st_union(base_area))

  p_base +
    geom_sf(data = base_area, fill = "grey30", color = "white") +
    geom_sf(data = g_map_data, aes(fill = "Overall Range"), color = "transparent", alpha = 0.8) +
    geom_sf(data = aoa, fill = "yellow", color = "transparent") +
    scale_fill_manual(values = c("#1e8449")) +
    labs(
      title = sp_names,
      subtitle = "Continental United States Range",
      fill = "**Legend**",
      caption = source_statment
    )
}
```

```{r}
#| label: fig-breeding-range
#| fig-cap: "North American Seasonal Ranges"
#| fig-alt: "North American Seasonal Ranges"
#| fig-height: 6.5
if (m_source == "EBIRD") {
  base_area <- tar_read(evaluation_base_map_data)$north_america

  aoa <- tar_read(nnfg_aoa) |>
    st_transform(st_crs(base_area))

  g_map_data <- tar_read(bird_maps) |>
    filter(taxon_id == t_id) |>
    st_transform(st_crs(base_area)) |>
    st_intersection(base_area |> st_union())

  p_base +
    geom_sf(data = base_area, fill = "grey30", color = "white") +
    geom_sf(data = g_map_data, aes(fill = season), color = "transparent") +
    geom_sf(data = base_area, fill = "transparent", color = "white") +
    geom_sf(data = aoa, fill = "yellow", color = "transparent") +
    scale_fill_brewer(palette = "Dark2") +
    labs(
      title = sp_names,
      subtitle = "North American Range",
      fill = "**Season**",
      caption = "**Source:** eBird Status and Trends"
    )
}
```
:::
:::{custom-style="Caption"}
```{r}
#| label: occurrence-records
#| fig-cap: "North American Seasonal Ranges"
#| fig-alt: "North American Seasonal Ranges"
#| fig-height: 6

sp_points <- tar_read(all_eligible_spatial_data_point) |>
  filter(taxon_id == t_id)

sp_polys <- tar_read(all_eligible_spatial_data_poly) |>
  filter(taxon_id == t_id)

unit_sp <- tar_read(nnfg_bd)

p_base +
  geom_sf(data = unit_sp, fill = "grey20", color = "transparent") +
  geom_sf(data = sp_polys, fill = "#1e8449") +
  geom_sf(data = sp_points, size = 1.5, aes(color = "Observation")) +
  scale_color_manual(values = c("#1e8449")) +
  labs(
    title = sp_names,
    subtitle = "Distribution within the Nebraska National Grasslands and Forests",
    color = "**Legend**"
  )
```
:::
:::{custom-style="Body Text"}


### Is the species native and known to occur?

```{r}
nn_base <- species_data |>
  pull(`Is the Species Native and Known to Occur`)
nn_basi <- species_data |>
  pull(`What is the rationale and supporting BASI for recommending that an observation does not meet the requirements of native to, and known to occur in the plan area?`)
```

`r nn_base`

#### Justification for ‘no’:

`r ifelse(is.na(nn_basi), "", nn_basi)`

## Species information

### Species Current Range Size and Configuration

#### What is the size of the species' range?

[Large, Moderate, Regional Endemic, State Endemic, Local Endemic – refer to process paper for category definitions]

#### Is the portion of the species range that overlaps the plan area disjunct from the main range of the species (i.e., the range overlapping the plan area is smaller and not connected to the larger range of the species)?

[Yes, No, Unknown]

#### Based on the species’ ecology and the environmental conditions present, does the plan area overlap the edge of the species range?

[Yes, No, Unknown]

### Species’ Landscape-scale Habitat

#### What are the landscape-scale habitat types or ecosystems the species occupies based on Best Available Scientific Information (BASI), inside and out of the plan area. 

[Narrative description pulled in from NatureServe– will need manual review to ensure fine-scale habitat features are not mixed in with landscape, and additional BASI as appropriate; NatureServe also doesn’t capture many plants, so this may also need to be written manually]

#### Based on BASI , what are the landscape-scale habitat types or ecosystems in the plan area are likely to support the species?

[Checklist of categories from Ecology Group pulled in from spreadsheet – this will get pulled in automatically from Mike’s NatureServe pull + crosswalk, but will still require manual review for accuracy (especially for the plantation category)]

#### Macrohabitat Availability and Distribution

[See Appendix.]

#### Species Response to Macrohabitat Threats and Trends

[Intent of this section is to tier to the Appendix, but bring in any species-specific info about how the species responds to general habitat trends/threats. The appendix explains the macrohabitat availability, distribution, and threats, but this is where you would connect it to the species- e.g., if fire is a threat, but species actually needs fire for its seeds to germinate, or it actually uses roadside habitat so road development is not as much of a threat].


:::



